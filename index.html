<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Rental System | CloudBikes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Set up custom Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1e40af', // Darker blue for accents
                        'primary-indigo': '#4f46e5', // Indigo for admin/buttons
                        'dark-bg': '#1f2937', // Dark gray for background
                    }
                },
            },
            // Enable custom classes in the style block
            corePlugins: {
                preflight: false,
            },
        }
    </script>
    <style>
        /* Custom Styles and Background Image */
        body {
            font-family: 'Inter', sans-serif;
            /* Using a dark color as a fallback */
            background-color: #1f2937; 
            /* Replace 'your-bike-background.jpg' with an actual path/URL to a high-quality bike image */
            background-image: url('https://images.unsplash.com/photo-1579624536768-b8077c59a72f?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Overlay for readability */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.65); /* Dark semi-transparent overlay */
            z-index: -1;
        }

        /* Card styles for lift and shadow */
        .card-lift {
            transition: all 0.3s ease;
        }
        .card-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        /* Custom scrollbar for better look (Webkit browsers) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="background-overlay"></div>

    <div class="container mx-auto max-w-4xl p-4 sm:p-8 relative z-10">
        
        <header class="mb-10 text-white">
            <h1 class="text-5xl font-extrabold text-center text-primary-blue drop-shadow-lg tracking-wider">CloudBikes</h1>
            <p class="text-center text-gray-300 mt-2 font-light">Your high-speed journey starts now.</p>
        </header>

        <div id="login-register-view" class="max-w-md mx-auto">
            <div class="bg-white p-8 rounded-xl shadow-2xl card-lift">
                
                <form id="login-form">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Rider Login</h2>
                    <div id="auth-error" class="hidden text-red-700 bg-red-100 p-3 rounded-lg mb-4 text-sm font-medium border border-red-300"></div>
                    <div class="space-y-6">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="login-email" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out" required>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out" required>
                        </div>
                        <button type="submit" class="w-full bg-primary-blue text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 font-semibold text-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg">Login to Ride</button>
                    </div>
                    <p class="text-center text-sm text-gray-600 mt-6">
                        New here? 
                        <a href="#" id="show-register-form" class="font-bold text-primary-blue hover:text-blue-500 transition duration-150 ease-in-out">Create your account</a>
                    </p>
                </form>

                <form id="register-form" class="hidden">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Join CloudBikes</h2>
                    <div id="register-error" class="hidden text-red-700 bg-red-100 p-3 rounded-lg mb-4 text-sm font-medium border border-red-300"></div>
                    <div class="space-y-6">
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="register-email" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out" required>
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700">Secure Password</label>
                            <input type="password" id="register-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 font-semibold text-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg">Create Account</button>
                    </div>
                    <p class="text-center text-sm text-gray-600 mt-6">
                        Already a member? 
                        <a href="#" id="show-login-form" class="font-bold text-primary-blue hover:text-blue-500 transition duration-150 ease-in-out">Login here</a>
                    </p>
                </form>

            </div>
        </div>

        <div id="app-content" class="hidden">
            <div id="user-info" class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-primary-blue">
                <div class="flex justify-between items-center">
                    <div>
                        <p id="auth-status" class="text-lg text-green-700 font-semibold"></p>
                        <p id="user-role" class="text-sm text-primary-indigo font-bold mt-1"></p>
                    </div>
                    <button id="sign-out-btn" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 font-medium text-base transition duration-150 ease-in-out shadow-md">Sign Out</button>
                </div>
                <p id="user-id" class="text-xs text-gray-400 break-all mt-3 text-left border-t pt-2"></p>
            </div>

            <div id="loading-view" class="text-center p-10 bg-white rounded-xl shadow-lg">
                <svg class="animate-spin h-10 w-10 text-primary-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-3 text-gray-600 font-medium">Checking user role...</p>
            </div>

            <div id="customer-view" class="hidden space-y-8">
                
                <section class="bg-white p-6 rounded-xl shadow-lg card-lift">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Rent a Bike üèçÔ∏è</h2>
                    <form id="rental-form" class="space-y-5">
                        <div>
                            <label for="bike-select" class="block text-sm font-medium text-gray-700">Available Bike Models</label>
                            <select id="bike-select" name="bike-select" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out" required>
                                <option value="">Select a bike...</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="rental-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                                <input type="date" id="rental-start-date" name="rental-start-date" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out" required>
                            </div>
                            <div>
                                <label for="rental-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                                <input type="date" id="rental-end-date" name="rental-end-date" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out" required>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-primary-blue text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 font-semibold text-lg transition duration-150 ease-in-out shadow-md">Request Rental</button>
                    </form>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">My Current Rentals üìÖ</h2>
                    <ul id="my-rentals-list" class="space-y-4">
                        <li id="my-rentals-empty" class="text-center text-gray-500 py-4 font-medium">You have no active or pending rentals.</li>
                    </ul>
                </section>

            </div>

            <div id="admin-view" class="hidden space-y-8">

                <section class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Manage Bike Inventory üõ†Ô∏è</h2>
                    <form id="add-bike-form" class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0 mb-8">
                        <input type="text" id="bike-model" class="flex-grow border border-gray-300 rounded-lg p-3 focus:ring-primary-indigo focus:border-primary-indigo transition duration-150 ease-in-out" placeholder="Bike Model (e.g., Honda Activa)" required>
                        <input type="number" id="bike-rate" class="w-full sm:w-1/3 border border-gray-300 rounded-lg p-3 focus:ring-primary-indigo focus:border-primary-indigo transition duration-150 ease-in-out" placeholder="Rate (‚Çπ/Day)" required>
                        <button type="submit" class="w-full sm:w-1/4 bg-primary-indigo text-white px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 font-medium shadow-md">Add Bike</button>
                    </form>
                    
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Current Fleet</h3>
                    <ul id="admin-bike-list" class="space-y-3">
                        <li id="admin-bikes-empty" class="text-center text-gray-500 py-4 font-medium">No bikes found. Add one above.</li>
                    </ul>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">All Rental Requests üìã</h2>
                    <ul id="all-rentals-list" class="space-y-4">
                        <li id="all-rentals-empty" class="text-center text-gray-500 py-4 font-medium">There are no rental requests.</li>
                    </ul>
                </section>

            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCzg_7yjmg956Dnd_ZaXsv7YRW8qdzLIjA",
            authDomain: "cloudbike-7b44b.firebaseapp.com",
            projectId: "cloudbike-7b44b",
            storageBucket: "cloudbike-7b44b.firebasestorage.app",
            messagingSenderId: "496112498753",
            appId: "1:496112498753:web:8251f1b4c8e81924e4eec0",
            measurementId: "G-PR3S4LG81J"
        };
    </script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            addDoc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            where,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UI ELEMENTS ---
        const loginRegisterView = document.getElementById('login-register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterFormBtn = document.getElementById('show-register-form');
        const showLoginFormBtn = document.getElementById('show-login-form');
        const authErrorEl = document.getElementById('auth-error');
        const registerErrorEl = document.getElementById('register-error');

        const appContent = document.getElementById('app-content');
        const signOutBtn = document.getElementById('sign-out-btn');
        const authStatusEl = document.getElementById('auth-status');
        const userIdEl = document.getElementById('user-id');
        const userRoleEl = document.getElementById('user-role');
        const loadingView = document.getElementById('loading-view');
        const customerView = document.getElementById('customer-view'); 
        const adminView = document.getElementById('admin-view');

        // Customer View Elements
        const rentalForm = document.getElementById('rental-form');
        const bikeSelect = document.getElementById('bike-select');
        const rentalStartDate = document.getElementById('rental-start-date');
        const rentalEndDate = document.getElementById('rental-end-date');
        const myRentalsList = document.getElementById('my-rentals-list');
        const myRentalsEmpty = document.getElementById('my-rentals-empty');

        // Admin View Elements
        const addBikeForm = document.getElementById('add-bike-form');
        const bikeModelInput = document.getElementById('bike-model');
        const bikeRateInput = document.getElementById('bike-rate');
        const adminBikeList = document.getElementById('admin-bike-list');
        const adminBikesEmpty = document.getElementById('admin-bikes-empty');
        const allRentalsList = document.getElementById('all-rentals-list');
        const allRentalsEmpty = document.getElementById('all-rentals-empty');

        // --- FIREBASE & APP STATE ---
        let app, auth, db;
        let userId;
        let userRole = 'customer'; 
        let unsubscribeBikes = null; 
        let unsubscribeRentals = null; 

        // --- FIREBASE INITIALIZATION & AUTH ---

        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase config is not set. Please paste your config object in index.html.");
                authErrorEl.textContent = 'Error: Firebase config missing. Please paste your config object from the Firebase console.';
                authErrorEl.classList.remove('hidden');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); 

                console.log("Firebase initialized. Waiting for auth state change...");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // USER IS LOGGED IN
                        userId = user.uid;
                        console.log("User is authenticated:", userId);

                        // Show app, hide login
                        loginRegisterView.classList.add('hidden');
                        appContent.classList.remove('hidden');
                        loadingView.classList.remove('hidden'); // Show loader while checking role
                        customerView.classList.add('hidden'); 
                        adminView.classList.add('hidden');

                        authStatusEl.textContent = 'Backend Connected';
                        authStatusEl.classList.add('text-green-600');
                        userIdEl.textContent = `User ID: ${userId}`;

                        // Check the user's role
                        await checkUserRole(userId);
                        
                        // Show the correct UI
                        setupUIBasedOnRole();

                    } else {
                        // USER IS LOGGED OUT
                        console.log("User is not authenticated.");
                        
                        // Show login, hide app
                        loginRegisterView.classList.remove('hidden');
                        appContent.classList.add('hidden');
                        loadingView.classList.add('hidden');
                        
                        userId = null;
                        userRole = 'customer'; // Default role
                        cleanupListeners();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusEl.textContent = 'Error connecting to backend. Check console.';
                authStatusEl.classList.add('text-red-600');
            }
        }

        // --- AUTH HANDLERS (Login, Register, Logout) ---
        // (Unchanged logic, just using new element IDs for forms)

        async function handleLogin(e) {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;

            try {
                authErrorEl.classList.add('hidden');
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Login Error:", error.message);
                authErrorEl.textContent = getFriendlyAuthError(error.code);
                authErrorEl.classList.remove('hidden');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;

            try {
                registerErrorEl.classList.add('hidden');
                // 1. Create user in Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. Create their role document in Firestore
                // New users default to 'customer'
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, { role: 'customer' }); 
                
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Register Error:", error.message);
                registerErrorEl.textContent = getFriendlyAuthError(error.code);
                registerErrorEl.classList.remove('hidden');
            }
        }

        async function handleSignOut() {
            await signOut(auth);
            // onAuthStateChanged will handle the rest
        }

        function getFriendlyAuthError(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'Invalid email or password.';
                case 'auth/email-already-in-use':
                    return 'This email address is already registered.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                default:
                    return 'An unknown error occurred. Please try again.';
            }
        }

        // Toggle between Login and Register forms
        showRegisterFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authErrorEl.classList.add('hidden');
        });

        showLoginFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            registerErrorEl.classList.add('hidden');
        });


        // --- ROLE-BASED UI & DATA ---

        async function checkUserRole(uid) {
            try {
                const userDocRef = doc(db, "users", uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    userRole = 'admin';
                    console.log("User role is: ADMIN");
                } else {
                    userRole = 'customer'; 
                    console.log("User role is: CUSTOMER");
                }
                userRoleEl.textContent = `Role: ${userRole.toUpperCase()}`;
            } catch (error) {
                console.error("Error checking user role:", error);
                userRole = 'customer'; // Default to customer on error
                userRoleEl.textContent = 'Role: Customer (default)';
            }
        }

        function setupUIBasedOnRole() {
            loadingView.classList.add('hidden');
            cleanupListeners(); // Clear any old listeners

            if (userRole === 'admin') {
                // Admin Setup
                adminView.classList.remove('hidden');
                customerView.classList.add('hidden');
                
                listenForBikes(true); // true = admin mode
                listenForAllRentals();

            } else {
                // Customer Setup
                customerView.classList.remove('hidden');
                adminView.classList.add('hidden');
                
                listenForBikes(false); // false = customer mode
                listenForMyRentals();
            }
        }

        function cleanupListeners() {
            if (unsubscribeBikes) unsubscribeBikes();
            if (unsubscribeRentals) unsubscribeRentals();
        }

        // --- BIKE INVENTORY MANAGEMENT (Admin & Customer) ---

        function listenForBikes(isAdmin) {
            const bikesCollection = collection(db, "bikes");
            
            unsubscribeBikes = onSnapshot(bikesCollection, (snapshot) => {
                const bikes = [];
                snapshot.forEach(doc => bikes.push({ id: doc.id, ...doc.data() }));
                
                if (isAdmin) {
                    renderAdminBikeList(bikes);
                } else {
                    renderCustomerBikeOptions(bikes);
                }
            }, (error) => {
                console.error("Error listening for bikes:", error);
            });
        }

        // (Admin) Render bike list with delete buttons
        function renderAdminBikeList(bikes) {
            adminBikeList.innerHTML = '';
            if (bikes.length === 0) {
                adminBikesEmpty.classList.remove('hidden');
                return;
            }
            
            adminBikesEmpty.classList.add('hidden');
            bikes.forEach(bike => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm';
                li.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-900">${bike.model}</span>
                        <span class="text-sm text-primary-indigo ml-2 font-medium">(‚Çπ${bike.rate}/Day)</span>
                    </div>
                    <button data-id="${bike.id}" class="remove-bike-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-red-600 transition duration-150 ease-in-out">Remove</button>
                `;
                adminBikeList.appendChild(li);
            });
            // Event listener for removing bike is delegated below
        }

        // (Customer) Render bike <option> tags for the select dropdown
        function renderCustomerBikeOptions(bikes) {
            bikeSelect.innerHTML = '<option value="">Select a bike...</option>'; // Reset
            bikes.forEach(bike => {
                const option = document.createElement('option');
                option.value = bike.id;
                option.textContent = `${bike.model} (‚Çπ${bike.rate}/Day)`;
                option.dataset.model = bike.model; // Store model for later
                option.dataset.rate = bike.rate; // Store rate for later
                bikeSelect.appendChild(option);
            });
        }

        // (Admin) Add a new bike
        async function addBike(e) {
            e.preventDefault();
            const model = bikeModelInput.value.trim();
            const rate = parseFloat(bikeRateInput.value);

            if (model && !isNaN(rate) && rate > 0) {
                try {
                    await addDoc(collection(db, "bikes"), { model, rate, available: true });
                    bikeModelInput.value = '';
                    bikeRateInput.value = '';
                } catch (error) {
                    console.error("Error adding bike:", error);
                }
            } else {
                alert("Please enter a valid bike model and a positive rental rate.");
            }
        }

        // (Admin) Remove a bike
        async function removeBike(e) {
            const id = e.target.dataset.id;
            if (confirm("Are you sure you want to remove this bike from inventory?")) {
                try {
                    await deleteDoc(doc(db, "bikes", id));
                } catch (error) {
                    console.error("Error removing bike:", error);
                }
            }
        }

        // --- RENTAL MANAGEMENT ---

        // (Customer) Request a new rental
        async function requestRental(e) {
            e.preventDefault();
            const selectedOption = bikeSelect.options[bikeSelect.selectedIndex];
            
            if (!selectedOption.value) {
                alert("Please select a bike model.");
                return;
            }

            const rental = {
                customerId: userId, 
                bikeId: selectedOption.value,
                bikeModel: selectedOption.dataset.model,
                rentalRate: parseFloat(selectedOption.dataset.rate), 
                startDate: rentalStartDate.value,
                endDate: rentalEndDate.value,
                status: 'Requested' 
            };

            // Basic Date Validation
            if (new Date(rental.startDate) >= new Date(rental.endDate)) {
                alert("End date must be after start date.");
                return;
            }
            if (new Date(rental.startDate) < new Date().setHours(0,0,0,0)) {
                alert("Start date cannot be in the past.");
                return;
            }

            try {
                await addDoc(collection(db, "rentals"), rental);
                rentalForm.reset();
                alert("Rental request submitted successfully! Wait for Admin confirmation.");
            } catch (error) {
                console.error("Error requesting rental:", error);
            }
        }

        // (Customer) Listen for *only* their own rentals
        function listenForMyRentals() {
            const q = query(collection(db, "rentals"), where("customerId", "==", userId));
            
            unsubscribeRentals = onSnapshot(q, (snapshot) => {
                const rentals = [];
                snapshot.forEach(doc => rentals.push({ id: doc.id, ...doc.data() }));
                renderMyRentals(rentals);
            }, (error) => {
                console.error("Error listening for my rentals:", error);
            });
        }

        // (Customer) Render their list of rentals
        function renderMyRentals(rentals) {
            myRentalsList.innerHTML = '';
            if (rentals.length === 0) {
                myRentalsEmpty.classList.remove('hidden');
                return;
            }

            myRentalsEmpty.classList.add('hidden');
            rentals.forEach(r => {
                const li = document.createElement('li');
                const statusClass = r.status === 'Requested' ? 'bg-yellow-100 text-yellow-700' : 
                                     r.status === 'Confirmed' ? 'bg-green-100 text-green-700' : 
                                     'bg-red-100 text-red-700';

                li.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg border-l-4 border-primary-blue shadow-sm';
                li.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-900">${r.bikeModel}</p>
                        <p class="text-sm text-gray-700">From: ${r.startDate} to ${r.endDate}</p>
                        <span class="text-xs font-medium px-2 py-1 rounded ${statusClass} inline-block mt-2">Status: ${r.status}</span>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <p class="font-bold text-lg text-primary-blue">‚Çπ${r.rentalRate}/Day</p>
                        ${r.status !== 'Cancelled' ? `<button data-id="${r.id}" class="cancel-rental-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-red-600 mt-2 transition duration-150 ease-in-out">Cancel</button>` : ''}
                    </div>
                `;
                myRentalsList.appendChild(li);
            });
        }

        // (Admin) Listen for *all* rentals
        function listenForAllRentals() {
            const q = query(collection(db, "rentals"));

            unsubscribeRentals = onSnapshot(q, async (snapshot) => {
                const rentals = [];
                snapshot.forEach(doc => rentals.push({ id: doc.id, ...doc.data() }));
                
                // Fetch all user emails for admin view
                const rentalsWithEmails = await Promise.all(rentals.map(async (r) => {
                    let email = r.customerId; // Default to ID
                    try {
                        // NOTE: Getting user email from auth outside of a cloud function is complex/expensive.
                        // In a real app, you'd store the email in the 'users' doc on register or use a CF.
                        // For simplicity, we'll try to fetch the 'users' doc (which doesn't contain email in this simple setup)
                        // and stick to showing the Customer ID.
                    } catch (e) {
                        console.warn("Could not fetch user email for rental:", r.id, e);
                    }
                    return { ...r, customerEmailOrId: email };
                }));

                renderAllRentals(rentalsWithEmails);
            }, (error) => {
                console.error("Error listening for all rentals:", error);
            });
        }

        // (Admin) Render all rentals
        function renderAllRentals(rentals) {
            allRentalsList.innerHTML = '';
            if (rentals.length === 0) {
                allRentalsEmpty.classList.remove('hidden');
                return;
            }

            allRentalsEmpty.classList.add('hidden');
            rentals.forEach(r => {
                const li = document.createElement('li');
                li.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm';
                const isConfirmed = r.status === 'Confirmed';
                const isCancelled = r.status === 'Cancelled';
                
                const statusClass = isConfirmed ? 'bg-green-100 text-green-700' : 
                                    isCancelled ? 'bg-red-100 text-red-700' :
                                    'bg-yellow-100 text-yellow-700';

                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-gray-900 text-lg">${r.bikeModel} <span class="text-sm text-primary-indigo font-medium">(‚Çπ${r.rentalRate}/Day)</span></p>
                            <p class="text-sm text-gray-700 mt-1">Period: ${r.startDate} to ${r.endDate}</p>
                            <p class="text-xs text-gray-500 break-all pt-1">Customer ID: ${r.customerId.substring(0, 8)}...</p>
                        </div>
                        <span class="text-sm font-medium px-2 py-1 rounded ${statusClass} whitespace-nowrap">${r.status}</span>
                    </div>
                    
                    <div class="flex items-center space-x-2 mt-3 pt-3 border-t">
                        ${!isConfirmed && !isCancelled ? `<button data-id="${r.id}" class="confirm-rental-btn bg-primary-indigo text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-indigo-700 transition duration-150 ease-in-out">Confirm Rental</button>` : ''}
                        ${!isCancelled ? `<button data-id="${r.id}" class="cancel-rental-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-red-600 transition duration-150 ease-in-out">Cancel</button>` : ''}
                    </div>
                `;
                allRentalsList.appendChild(li);
            });
        }

        // (Customer or Admin) Cancel a rental
        async function cancelRental(id) {
            if (confirm("Are you sure you want to cancel this rental?")) {
                try {
                    await setDoc(doc(db, "rentals", id), { status: 'Cancelled' }, { merge: true });
                } catch (error) {
                    console.error("Error canceling rental:", error);
                }
            }
        }
        
        // (Admin) Confirm a rental
        async function confirmRental(id) {
            try {
                await setDoc(doc(db, "rentals", id), { status: 'Confirmed' }, { merge: true });
            } catch (error) {
                console.error("Error confirming rental:", error);
            }
        }

        // --- EVENT LISTENERS ---
        
        // Auth Listeners
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        signOutBtn.addEventListener('click', handleSignOut);
        
        // Customer Listeners
        rentalForm.addEventListener('submit', requestRental);
        // Event delegation for my rentals
        myRentalsList.addEventListener('click', (e) => {
             if (e.target.classList.contains('cancel-rental-btn')) {
                cancelRental(e.target.dataset.id);
             }
        });

        // Admin Listeners
        addBikeForm.addEventListener('submit', addBike);
        adminBikeList.addEventListener('click', (e) => {
             if (e.target.classList.contains('remove-bike-btn')) {
                 removeBike(e);
             }
        });

        allRentalsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('cancel-rental-btn')) {
                cancelRental(e.target.dataset.id);
            }
            if (e.target.classList.contains('confirm-rental-btn')) {
                confirmRental(e.target.dataset.id);
            }
        });

        // --- START THE APP ---
        initializeFirebase();

    </script>
</body>
</html>
